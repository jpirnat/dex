#!/usr/bin/env php
<?php
declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';
require __DIR__ . '/../config/environment.php';
$container = require __DIR__ . '/../config/dependencies.php';

/** @var PDO $database */
$database = $container->get('$dbsetup');

// Load the dex schema and data, one table at a time.
$tables = require __DIR__ . '/../sql/schema/dex/tables.php';
foreach ($tables as $table) {
	// Create the table from its schema definition.
	$database->exec(file_get_contents(__DIR__ . "/../sql/schema/dex/$table.sql"));

	// Load the table's data from its csv.
	$file = __DIR__ . "/../data/$table.csv";
	$database->exec(
		"LOAD DATA LOCAL INFILE '$file'
		INTO TABLE `$table`
		FIELDS
			TERMINATED BY ','
			OPTIONALLY ENCLOSED BY '\"'
		IGNORE 1 LINES"
	);

	echo "Loaded $table\n";
}

// Load the stats schema, one table at a time.
$tables = require __DIR__ . '/../sql/schema/stats/tables.php';

foreach ($tables as $table) {
	// Create the table from its schema definition.
	$database->exec(file_get_contents(__DIR__ . "/../sql/schema/stats/$table.sql"));
}

echo "Done!\n";
